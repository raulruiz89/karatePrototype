name: Karate Tests

on:
  push:
    branches: [ main, develop ]
    # evita bucles cuando el propio workflow sube docs/
    paths-ignore:
      - 'docs/**'
      - 'target/**'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write

# Un solo deployment a la vez (por seguridad)
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      RUN_ID: ${{ github.run_number }}
      REPORTS_SUBDIR: reports/${{ github.ref_name }}
      RUN_DIR: run-${{ github.run_number }}
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn -q -DskipTests=false clean test

      - name: Ensure build produced Karate reports
        id: have_reports
        run: |
          if [ ! -d target/karate-reports ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "No Karate reports found, skipping publication."
          else
            echo "found=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare reports payload
        if: steps.have_reports.outputs.found == 'true'
        run: |
          mkdir -p payload/${REPORTS_SUBDIR}/${RUN_DIR}
          cp -r target/karate-reports/* "payload/${REPORTS_SUBDIR}/${RUN_DIR}/"
          # alias "latest" para la rama
          rm -rf "payload/${REPORTS_SUBDIR}/latest" || true
          mkdir -p "payload/${REPORTS_SUBDIR}"
          cp -r target/karate-reports "payload/${REPORTS_SUBDIR}/latest"
          # índice simple por rama
          mkdir -p payload
          cat > payload/index.html <<'HTML'
          <!doctype html><meta charset="utf-8">
          <title>Karate Reports</title>
          <h1>Karate Reports</h1>
          <ul>
            <li><a href="./reports/main/latest/karate-summary.html">main / latest</a></li>
            <li><a href="./reports/develop/latest/karate-summary.html">develop / latest</a></li>
          </ul>
          <p>Runs:</p>
          <ul>
            <li><a href="./reports/main/">main runs</a></li>
            <li><a href="./reports/develop/">develop runs</a></li>
          </ul>
          HTML
          touch payload/.nojekyll

      # Publica en main/docs SIN PR
      - name: Checkout main (target pages branch) to pages/
        if: steps.have_reports.outputs.found == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          path: pages
          fetch-depth: 0
          persist-credentials: true

      - name: Update main/docs with reports
        if: steps.have_reports.outputs.found == 'true'
        run: |
          mkdir -p pages/docs
          # Fusiona payload → docs manteniendo histórico por rama/run
          rsync -a payload/ pages/docs/
          cd pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git commit -m "chore(reports): publish ${BRANCH_NAME} -> docs/${REPORTS_SUBDIR}/${RUN_DIR} [skip ci]" || echo "No changes to commit"
          git push origin main