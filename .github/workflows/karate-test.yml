name: Karate Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test:
    # Evita loop: si el commit lo hace el bot, no corras
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      RUN_ID: ${{ github.run_number }}
      REPORTS_SUBDIR: reports/${{ github.ref_name }}
      RUN_DIR: run-${{ github.run_number }}

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn -q -DskipTests=false clean test

      - name: Ensure build produced Karate reports
        id: have_reports
        run: |
          if [ ! -d target/karate-reports ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "No Karate reports found, skipping publication."
          else
            echo "found=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare reports payload
        if: steps.have_reports.outputs.found == 'true'
        run: |
          mkdir -p payload/${REPORTS_SUBDIR}/${RUN_DIR}
          cp -r target/karate-reports/* "payload/${REPORTS_SUBDIR}/${RUN_DIR}/"
          rm -rf "payload/${REPORTS_SUBDIR}/latest" || true
          mkdir -p "payload/${REPORTS_SUBDIR}"
          cp -r target/karate-reports "payload/${REPORTS_SUBDIR}/latest"
          cat > payload/index.html <<'HTML'
          <!doctype html><meta charset="utf-8">
          <title>Karate Reports</title>
          <h1>Karate Reports</h1>
          <ul>
            <li><a href="./reports/main/latest/karate-summary.html">main / latest</a></li>
            <li><a href="./reports/develop/latest/karate-summary.html">develop / latest</a></li>
          </ul>
          <p>Runs:</p>
          <ul>
            <li><a href="./reports/main/">main runs</a></li>
            <li><a href="./reports/develop/">develop runs</a></li>
          </ul>
          HTML
          touch payload/.nojekyll

      # Publicar en main/docs (Pages)
      - name: Checkout main (pages target) into pages/
        if: steps.have_reports.outputs.found == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          path: pages
          fetch-depth: 0
          persist-credentials: true

      - name: Update main/docs with reports
        if: steps.have_reports.outputs.found == 'true'
        run: |
          mkdir -p pages/docs
          rsync -a payload/ pages/docs/
          cd pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git commit -m "chore(reports): publish ${BRANCH_NAME} -> docs/${REPORTS_SUBDIR}/${RUN_DIR} [skip ci]" || echo "No changes to commit"
          git push origin main

      # Crear rama por ejecuci√≥n con los reportes (para historial navegable en GitHub)
      - name: Create per-run reports branch
        if: steps.have_reports.outputs.found == 'true'
        run: |
          cd pages
          git switch --orphan "reports/${BRANCH_NAME}/run-${RUN_ID}"
          git rm -rf . || true
          cp -r ../payload/* ./
          git add .
          git commit -m "reports: ${BRANCH_NAME} run ${RUN_ID}"
          git push origin "reports/${BRANCH_NAME}/run-${RUN_ID}"
          git switch main

      - name: Output useful links
        if: steps.have_reports.outputs.found == 'true'
        run: |
          echo "::notice title=Pages URL::https://raulruiz89.github.io/karatePrototype/${{ env.REPORTS_SUBDIR }}/latest/karate-summary.html"
          echo "::notice title=Run branch::https://github.com/raulruiz89/karatePrototype/tree/reports/${{ env.BRANCH_NAME }}/run-${{ env.RUN_ID }}"